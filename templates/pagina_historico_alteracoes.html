<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Histórico de Alterações</title>
    <!-- Carregamento do Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Configuração da fonte Inter */
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        /* Estilo para a linha do tempo */
        
        .timeline-item {
            position: relative;
            padding-left: 2.5rem;
            /* Espaço para o ícone */
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: 0.5rem;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: #cbd5e1;
            /* gray-300 */
        }
        
        .timeline-dot {
            position: absolute;
            left: 0;
            top: 0.5rem;
            height: 1rem;
            width: 1rem;
            border-radius: 50%;
            background-color: #4f46e5;
            /* indigo-600 */
            z-index: 10;
            border: 3px solid #f7f9fb;
            /* Cor de fundo para destacar */
        }
    </style>
</head>

<body class="min-h-screen flex flex-col">

    <!-- Navbar Responsiva (fixa no topo) -->
    <header class="bg-indigo-700 shadow-lg sticky top-0 z-10">
        <div class="container mx-auto p-4 flex justify-between items-center flex-wrap">
            <h1 class="text-2xl font-extrabold text-white">Histórico de Alterações</h1>
            <a href="/" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 shadow-md flex items-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3"></path>
                </svg>
                <span>Página Inicial</span>
            </a>
        </div>
    </header>

    <!-- Conteúdo Principal -->
    <main class="container mx-auto p-4 flex-grow py-8">

        <!-- Cabeçalho e Botão de Excluir Tudo -->
        <div class="flex justify-between items-center mb-6 border-b-2 border-indigo-200 pb-2">
            <h2 class="text-3xl font-bold text-gray-800">Log Completo do Sistema</h2>
            <!-- AÇÃO REAL: O formulário envia um POST para sua rota Flask /pagina/excluir/historico_alteracoes -->
            <form id="delete-all-form" action="/pagina/excluir/historico_alteracoes" method="POST">
                <button type="submit" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 shadow-md text-sm flex items-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 112 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                    </svg>
                    <span>Excluir Todos</span>
                </button>
            </form>
        </div>

        <!-- Mensagem de Confirmação (Modal de Exclusão em Massa) -->
        <div id="confirmation-message" class="hidden fixed top-0 left-0 w-full h-full bg-black bg-opacity-50 z-50 flex items-center justify-center">
            <div class="bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Confirmação Necessária</h3>
                <p class="text-gray-600 mb-6">Tem certeza que deseja **excluir permanentemente** todos os registros de alteração? Esta ação não pode ser desfeita.</p>
                <div class="flex justify-end space-x-3">
                    <button id="cancel-delete-all" class="px-4 py-2 text-gray-600 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-150">Cancelar</button>
                    <button id="confirm-delete-all" class="px-4 py-2 text-white bg-red-600 rounded-lg hover:bg-red-700 transition duration-150">Sim, Excluir Todos</button>
                </div>
            </div>
        </div>

        <!-- Barra de Busca/Filtro (Placeholder) -->
        <section class="mb-8 bg-white p-4 rounded-xl shadow-lg">
            <div class="flex flex-col md:flex-row items-center space-y-3 md:space-y-0 md:space-x-4">
                <input type="text" id="search-input" placeholder="Buscar por ação ou usuário..." class="p-3 border border-gray-300 rounded-lg w-full md:w-1/3 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                <select id="filter-select" class="p-3 border border-gray-300 rounded-lg w-full md:w-auto focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                    <option value="all">Todas as Ações</option>
                    <option value="adicao">Adições</option>
                    <option>Atualizações</option>
                    <option>Remoções</option>
                    <!-- Adicione mais opções baseadas nas ações reais do seu sistema -->
                </select>
            </div>
            <p class="text-sm text-gray-500 mt-2">A funcionalidade de busca e filtro deve ser implementada via JavaScript ou rota Flask.</p>
        </section>


        <!-- Timeline do Histórico -->
        <section id="history-log" class="mt-8">
            <h3 class="text-xl font-semibold text-gray-700 mb-4">Eventos Recentes</h3>

            <div class="bg-white p-6 rounded-xl shadow-lg">
                <!-- Verificação se o Flask passou dados de histórico. Corrigido para 'alteracoes' -->
                {% if alteracoes %}
                <div class="space-y-8">
                    <!-- Loop para renderizar cada item do histórico. Corrigido para 'alteracoes' -->
                    {% for item in alteracoes %}
                    <div class="timeline-item" data-cod-alteracao="{{ item.cod_alteracao }}">
                        <!-- Ponto na Timeline -->
                        <div class="timeline-dot"></div>

                        <!-- Conteúdo do Item -->
                        <div class="bg-indigo-50 p-4 rounded-lg border-l-4 border-indigo-600 shadow-sm transition duration-300 hover:shadow-md">

                            <!-- Cabeçalho do Log Item: Título, Data e Botão de Excluir -->
                            <div class="flex justify-between items-start flex-wrap">
                                <!-- Utilizando 'alteracao_realizada' como a descrição principal (vindo do log do banco de dados) -->
                                <h4 class="text-lg font-bold text-indigo-800 break-words w-full sm:w-auto flex-grow">{{ item.alteracao_realizada | truncate(60, True) | default("Alteração no Sistema") }}</h4>

                                <!-- Data e Botão de Excluir -->
                                <!-- Usamos item.cod_alteracao como ID de exclusão -->
                                <div class="flex items-center space-x-3 mt-1 sm:mt-0 whitespace-nowrap ml-4">
                                    <span class="text-xs font-semibold text-gray-500">{{ item.data_hora }}</span>
                                    <!-- Botão de Excluir: Usado para acionar a função DELETE via fetch -->
                                    <button data-delete-id="{{ item.cod_alteracao }}" class="delete-log-btn text-red-600 hover:text-red-800 p-1 rounded-full hover:bg-red-100 transition duration-150" title="Excluir Alteração">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 112 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                                                </svg>
                                            </button>
                                </div>
                            </div>

                            <!-- Exibindo a descrição completa -->
                            <p class="text-sm text-gray-700 mt-2">{{ item.alteracao_realizada }}</p>

                            <!-- Informação do Usuário (se disponível) -->
                            {% if item.cpf %}
                            <!-- Assumindo que o campo retornado é o CPF, se o nome do usuário ('usuario') não for resolvido -->
                            <p class="text-xs text-gray-500 mt-1">Usuário (CPF): <span class="font-medium">{{ item.cpf }}</span></p>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <!-- Mensagem de histórico vazio -->
                <div class="text-center p-8 bg-gray-100 rounded-lg border border-gray-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-gray-400 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 21h7a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414a1 1 0 00-.707-.293H7a2 2 0 00-2 2v11m0 0l-1.558 1.558c-.356.356-.558.835-.558 1.328a2 2 0 002 2h10l2-2.5-2-2.5H7z"></path>
                        </svg>
                    <p class="text-gray-600 text-lg font-medium">Nenhum registro de alteração encontrado.</p>
                    <p class="text-sm text-gray-500 mt-1">Comece a gerenciar suas estantes para popular o histórico!</p>
                </div>
                {% endif %}
            </div>

        </section>

    </main>

    <footer class="mt-8 p-4 text-center text-sm text-gray-500 border-t border-gray-200">
        Gerenciador de Estantes &copy; 2024
    </footer>

    <!-- Script de manipulação da UI e ações que chamam o backend -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const logContainer = document.getElementById('history-log');
            const deleteAllForm = document.getElementById('delete-all-form');
            const confirmationMessage = document.getElementById('confirmation-message');
            const confirmDeleteAllBtn = document.getElementById('confirm-delete-all');
            const cancelDeleteAllBtn = document.getElementById('cancel-delete-all');

            // 1. Lógica para Excluir um Item Individual (Fetch/Ação REAL no BD)
            logContainer.addEventListener('click', (event) => {
                const button = event.target.closest('.delete-log-btn');

                if (button) {
                    const deleteId = button.getAttribute('data-delete-id');

                    if (deleteId) {
                        const confirmIndividualDelete = window.confirm(`Tem certeza que deseja excluir a alteração com ID ${deleteId}?`);

                        if (confirmIndividualDelete) {
                            // URL DELETAR INDIVIDUAL: Você deve criar esta rota no seu Flask!
                            const deleteUrl = '/pagina/excluir/historico_alteracoes/individual';

                            console.log(`AÇÃO REAL: Enviando requisição para excluir ID ${deleteId} no servidor...`);

                            // Enviando a requisição POST com o ID para o servidor
                            fetch(deleteUrl, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    // Enviando o cod_alteracao no corpo da requisição
                                    body: JSON.stringify({
                                        cod_alteracao: deleteId
                                    })
                                })
                                .then(response => {
                                    // O Canvas não pode se conectar ao backend, então esta parte é simulada.
                                    // Se for um sucesso (response.ok), remova o item da UI:
                                    if (true) { // Substitua 'true' por 'response.ok' no seu código real
                                        const itemElement = button.closest('.timeline-item');
                                        if (itemElement) {
                                            itemElement.remove();
                                            console.log(`SUCESSO: ID ${deleteId} excluído.`);
                                        }
                                    } else {
                                        // Tratar erro do servidor
                                        console.error('ERRO: Falha ao excluir o registro no servidor.', response.status);
                                    }
                                })
                                .catch(error => {
                                    console.error('ERRO DE REDE:', error);
                                });
                        }
                    }
                }
            });

            // 2. Lógica para Excluir TODOS os Itens (Form Submit/Ação REAL no BD)

            // Interceptar a submissão do formulário e mostrar o modal
            deleteAllForm.addEventListener('submit', (event) => {
                event.preventDefault(); // Impede o envio padrão do formulário (para exibir o modal)
                confirmationMessage.classList.remove('hidden');
            });

            // Cancelar a exclusão (fechar o modal)
            cancelDeleteAllBtn.addEventListener('click', () => {
                confirmationMessage.classList.add('hidden');
            });

            // Confirmar a exclusão (submeter o formulário para a rota Flask)
            confirmDeleteAllBtn.addEventListener('click', () => {
                confirmationMessage.classList.add('hidden');

                console.log('AÇÃO REAL: Enviando requisição POST para a rota Flask para exclusão em massa...');

                // O método .submit() aciona o POST para /pagina/excluir/historico_alteracoes
                // e o Flask deve excluir e recarregar a página com o log vazio.
                deleteAllForm.submit();
            });
        });
    </script>
</body>

</html>